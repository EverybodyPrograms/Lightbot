<html>
	<head>
		<title>Cursebot</title>
		<script src="https://sirjosh3917.github.io/EEJSIDE/js/PlayerIOClient.development.js"></script>
		<script src="https://sirjosh3917.github.io/EEJSIDE/js/jsparse_clean.js"></script>
		<script src="https://sirjosh3917.github.io/EEJSIDE/js/BlockHandler.js"></script>
		<script src="https://sirjosh3917.github.io/EEJSIDE/js/ConnectHandler.js"></script>
		<link  href="https://sirjosh3917.github.io/EEJSIDE/styles.css" rel="stylesheet"/>
		<link rel="shortcut icon" type="image/png" href="curse.png"/>
		<style>
			body {
				font-family: monospace;
			}
			a {
				text-decoration: bold;
			color: #DDD
			}	
			h1,h2,p {
				color: white;
				text-align: center;
				font-family: monospace;
			}
			h3,h4,h5,h6 {
				color: white;
				font-family: monospace;
			}
			
			* {
			box-sizing: border-box;
			}
			label {
				color:white;
				font-size:12px;
			}

			input[type=checkbox]:hover {
				box-shadow:0px 0px 10px #1300ff;
			}
			body {
			  margin: 0;
			}
			/* Create three equal columns that floats next to each other */
			.column.settings {
				float: left;
				width: 30%;
				padding: 15px;
			}
			.column.input {
				float: left;
				width: 70%;
				padding: 15px;
			}

			/* Clear floats after the columns */
			.row:after {
				content: "";
				display: table;
				clear: both;
			}
			/* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
			@media screen and (max-width:417px) {
				.column.settings, .column.input {
					width: 100%;
				}
			}
		</style>
	</head>

	<body>

		<h1>Cursebot Online vIDK</h1>
		<p>Report bugs to the <a href="https://github.com/EverybodyPrograms/Cursebot">github page.</a></p>

		<div class="row">


			<div class="column settings">

				<h3>Settings</h3>
				<h5>These settings save in localhost, they will persist until removed manually<br>(hopefully)</h5>

				<form>
				<!--	<label> Username</label>
					<input id="textbox"type="text" name="username"><br> -->

					<input id="snakebox" type="checkbox" name="snake" value="Snake" style="color: white"><label> Snake<br></label>

					<input id="crownbox" type="checkbox" name="crown" value="Crowntowin" style="color: white"><label> Crown to win<br></label>

					<input id="trophybox" type="checkbox" name="trophy" value="Trophytowin" checked style="color: white"><label> Trophy to win<br></label>
					
					<input id="adminbox" type="checkbox" name="admins" value="Admins" disabled="disabled" checked style="color: white"><label> Admins<br></label>
					<input id="banbox" type="checkbox" name="bans" value="Bans" disabled="disabled" checked style="color: white"><label> Bans<br></label>
					
					<input id="friendbox" type="checkbox" name="friendsgetedit" value="Friendsgetedit" checked style="color: white"><label> Friends get edit<br></label>
					
					<input id="welcomebox" type="checkbox" name="welcomes" value="Welcomes" checked style="color: white"><label> Welcomes<br></label>
					
					<input id="byebox" type="checkbox" name="goodbyes" value="Goodbyes" checked style="color: white"><label> Goodbyes<br></label>
					
					<input id="deathbox" type="checkbox" name="deaths" value="deaths" checked style="color: white"><label> Death commands<br><br></label>
					
					<!-- <input type="text" id="userInput"/> -->

				</form>
				<input type="button" value="Submit" onclick="submit();">
			</div>

			<div class="column input">
				<table class="menu" style="width: 90%; margin-left: 5%; margin-right: 5%; margin-top: 15%;">
					<tbody>
						<tr><td><input id="input-email" type="text" placeholder="Username"/></td></tr>
						<tr><td><input id="input-password" type="password" placeholder="Password"/></td></tr>
						<tr><td><input id="input-worldid" type="text" placeholder="World ID" value="PWVzwJeNbUb0I"/></td></tr>
						<tr><td><input onclick="connect();" type="button" value="Connect"></td></tr>
						<tr><td><textarea id="log" rows=8></textarea></td></tr>
					</tbody>
				</table>
			</div>
	</div>
		<script>



			function submit() {
				try{snakeON = document.getElementById('snakebox'  ).checked;}catch(err){snakeON = false;}
				try{crowntowin = document.getElementById('crownbox'  ).checked;}catch(err){crowntowin = false;}
				try{trophytowin = document.getElementById('trophybox' ).checked;}catch(err){trophytowin = false;}
				admins = false;
				bans = false;
				try{friendsgetedit = document.getElementById('friendbox' ).checked;}catch(err){friendsgetedit = false;}
				try{welcomes = document.getElementById('welcomebox').checked;}catch(err){welcomes = false;}
				try{goodbyes = document.getElementById('byebox'    ).checked;}catch(err){goodbyes = false;}
				try{deathCommands = document.getElementById('deathbox'  ).checked;}catch(err){deathCommands = false;}
				try{adminInput = document.getElementById("userInput").value; }catch(err){adminInput = false;}
			}
//
		//	function getCookie(cname) {
//
		//		document.cookie = "username=John Doe; expires=2147483647; path=/";
		//		document.cookie = "username=; expires=Thu, 01 Jan 1970 00:00:00 UTC; //path=/;";
//
		//		var name = cname + "=";
		//		var decodedCookie = decodeURIComponent(document.cookie);
		//		var ca = decodedCookie.split(';');
//				for(var i = 0; i <ca.length; i++) {
		////			var c = ca[i];
////					while (c.charAt(0) == ' ') {
		////				c = c.substring(1);
//		//			}
		////			if (c.indexOf(name) == 0) {
//		//				return c.substring(name.length, c.length);
		////			}
//		//		}
		//		return "";
		//	}
			function connect() {
				let __EEJSIDE___ = document.getElementById("input-email");
				let __EEJSIDE____ = document.getElementById("input-password");
				let __EEJSIDE_____ = document.getElementById("input-worldid");
				let __EEJSIDE______ = document.getElementById("log");
				let __EEJSIDE_______ = function(msg, name = "EEJSIDE") {
					__EEJSIDE______.innerHTML += new Date().toUTCString() + " [" + name + "]: " + msg + "\n";
					__EEJSIDE______.scrollTo(0, __EEJSIDE______.scrollHeight);
				};
				
				var client;
				var connection;
				var log = function(msg) {
					__EEJSIDE_______(msg, "BOT");
				}
				
				__EEJSIDE_______("Authenticating");
				Promise.resolve(authenticate(__EEJSIDE___.value, __EEJSIDE____.value).then(__EEJSIDE_ => {
					
					__EEJSIDE_______("Joining Room");
					Promise.resolve(joinRoom(__EEJSIDE_.cli, __EEJSIDE_.cfg, __EEJSIDE_____.value).then(__EEJSIDE__ => {
						
						__EEJSIDE_______("Running User Script");
						client = __EEJSIDE_.cli;
						connection = __EEJSIDE__.con;

						//Here is where your bot code is!


///// NOTES /////

// BOT PLAN:
// make a bot that will run a curse tag minigame:
// - track players DONE
// - sense when a round starts DONE
// - give a random player curse for 10-30 seconds DONE
// - end round when one player is left DONE
// - clear player of effects DONE
// - give them coin DONE
// - restart round

// EXTENDED PLAN:
// - random boss themes?
// - better reward system
// - save progress into file

///// END NOTES /////



//  DEFINITIONS //
var testVar;
var playerid;
var team;
var ownerUsername;
var ownerID;

//  ARRAYS //
var player = [];  // Used to get usernames from user IDs
var playing = []; // Used to list users currently playing
var admins = [    // The admin list
	"yoshi626",
	"joebot456",
	"oooobo"
	]
var bans = [      // The ban list
	"thelizardface5151",
	"x"
]


// add a callback handler
// i have no idea what this even does tbh
connection.addMessageCallback("*", function(m) {
	switch(m.type) {
			

		// On join: 
		case "init": {

			// So i can store my username lol 
			// (mostly for getting my id because it changes every join)
			ownerUsername = m.getString(0);

			// Send finish join
			connection.send("init2");

		} break;
			

		// On finishing join:
		case "init2": {
			
			// say hi
			connection.send("say", "[CURSEBOT by joo456] Joined!");

			// go to the position of the npc
			connection.send("m", 11*16, 8*16, 0, 0, 0, 0, 0, 0, 0, false, false, 0);

			// hide behind the npc
			connection.send("say", "/kill joo456")

		} break;
			
		// On a user joining:
		case "add": {

			//  VARS  //
			var userid = m.getInt(0); // Get the user's ID 
			var username = m.getString(1); // Get the user's username

			// If the user is me,
			if (username == ownerUsername) {

				// Save my ID
				ownerID = userid;
			}

			// If the user is on the banlist,
			if (bans.includes(username)) {

				// Kick them
				connection.send("say", "/kick " + username + " You're on the ban list.")
			}

			// Add the user to the player array so they can be looked up via their userID
			player[userid] = username;

			// Tell me that the user joined, with their id for debug purposes 
			connection.send("pm", ownerID, "[DEBUG] " + username +" (" +userid+")" + " joined");
		} break;
			
		// When someone says something:
		case "say": {
			
			// VARS //
			playerid = m.getInt(0); // Get the user's ID
			input = m.getString(1); // Get what the user said
			
			// ok lemme break this down
			// IF the player is the owner (me) OR the player is on the admin list
			//  (playerid == ownerID)                   (admins.includes(player[playerid]))

			if((playerid == ownerID) || (admins.includes(player[playerid]))) {

			// They are allowed to use these commands:

				// Command to open the (G)reen door:
				if(input == "g") {
					
					// Hit the green key (51,9 are coordinates for the key)
					connection.send("pressKey", 51, 9, "green");
					
					// Say the door is open
					connection.send("say", "[CURSEBOT] Doors opened!");
				}

				// Command to start the game (C)urse
				else if(input == "c") {

					// Get random player from playing array
					var randomPlayer =  playing[Math.floor(Math.random()*playing.length)]

					// Give that random player curse for 20 seconds
					connection.send("say", "/giveeffect " + randomPlayer + " curse 20");

					// Say that the user has curse
					connection.send("say", "[CURSEBOT] " + randomPlayer + " has curse");
				}

				// Command to list the array playing (for debug purposes)
				else if(input == "aplaying") {

					// PM the user who sent the command the array (converted to a string)
					connection.send("pm", playerid, "Playing: " + playing.toString())
				}
			}
				
		} break;
		
		// When someone switches team: 
		case "team": {

			// VARS //
			playerid = m.getInt(0); // Get the user's ID
			team = m.getInt(1); // Get the team (Stored as a number from 0-6)
			
			// If the user switched to no team:
			if (team == 0) {

				// Remove them from the playing list (and perform checks for winning/continuing game)
				removePlaying(player[playerid])
			}

			// If the user switched to red team:
			if (team == 1) {

				// If the player is not in playing array:
				if ( !(playing.includes(player[playerid])) )  {

					// Add them to the array
					playing[playing.length] = player[playerid];

					// Tell me they were added to the array
					connection.send("pm", ownerID,  player[playerid] + " added to playing array"); 
				}	

				// Clear them of effects
				connection.send("say", "/ce " + player[playerid]);
			}

			// If the user switched to magenta team:
			if (team == 5) {

				// Clear them of effects
				connection.send("say", "/ce " + player[playerid]);
			}
	
		} break;

		// When someone is killed by an effect, /kill, or /killall:
		case "kill": {

			// VARS //
			playerid = m.getInt(0); // Get the user's ID

			// Remove them from the playing list (and perform checks for winning/continuing game)
			removePlaying(player[playerid]);
		} break;

		case "god": {

			// VARS //
			playerid = m.getInt(0); // Get the user's ID
			godON = m.getBoolean(1); // Get the status of godmode

			// If godmode is turned on:
			if (godON) {

				// If they're in the playing array:
				if (playing.includes(player[playerid])) {

					// Remove them from the playing list (and perform checks for winning/continuing game)
					// This is due to possible cheating (plus it breaks the game if they stay in godmode
					// to avoid dying from curse.
					removePlaying(player[playerid]);
					connection.send("say", "/tp " + player[playerid] + " 18 3")
					connection.send("say", "/ce " + player[playerid])
					connection.send("say", "/forcefly " + player[playerid] + " false")
					connection.send("pm", playerid, "No cheating!")
				}
			}
		} break;


		// If a player leaves
		case "left": {

			// VARS //
			playerid = m.getInt(0); // Get the user's ID

			removePlayer(player[playerid]);

			// This is gonna be buggy: if a player without curse leaves, its gonna be treated the same as if they died from curse. This is a temporary solution.
			removePlaying(player[playerid]);
		}

		// LOOK AT THIS TOMMORROW: IF SOMEONE IS IN THE PLAY AREA WITHOUT BEING ON PLAYING ARRAY TP THEM OUT

	//	case "m": {
	//		var x = m.getDouble(1) / 16
	//		var y = m.getDouble(2) / 16
			
	//		connection.send("say", ~~x + " " + ~~y)

		//	for (i = 15; i >= 50; i++) {
	//			if (((~~x > 15) && (~~x < 50)) && ((~~y > 11) && (~~y < 35)) ) {
	//				connection.send("say", "/ce " + player[playerid]);
	//				connection.send("say", "/tp " + player[playerid] + " 18 3");
	//				connection.send("pm", playerid, "No cheating!");
	//			}
		//	}

	//	}
	}
});

// Remove someone from the player array
function removePlayer(value) {

	// If they're on the player array
	if (playing.includes(player[playerid]) ) {

		// Remove "value" from player array
		player = player.filter(function(item) { return item !== value })
	}

}

// Remove someone from the playing array AND continue/finish the game
function removePlaying(value) {

	// If they are on the playing array
	if (playing.includes(player[playerid]) ) {

		// Remove "value" from playing array
		playing = playing.filter(function(item) { return item !== value })
		
		// Tell me they were removed
		connection.send("pm", ownerID, player[playerid] + " removed from playing array");


		// START GAME CHECKS

		// If there is only 1 person on the array left
		if (playing.length == 1) {

			// Give the last person a coin (by teleporting them to a mamchine that does that)
			connection.send("pm", ownerID, "PLAYING LENGTH IS 1, SOMEONE SHOULD GET WIN");
			connection.send("pm", ownerID, playing[0] + " SHOULD GET WIN")
			connection.send("say", "/tp " + playing[0] + " 0 85");
			connection.send("say", "[CURSEBOT] " + playing[0] + " won!");

			// Remove them from the array
			playing = playing.filter(function(item) { return item !== playing[0] });
		}
		else
		{	
			// Continue the game
			connection.send("pm", ownerID, "PLAYING LENGTH IS NOT 1, SOMEONE SHOULD GET CURSE");
			var randomPlayer =  playing[Math.floor(Math.random()*playing.length)]
			connection.send("pm", ownerID, randomPlayer + " SHOULD HAVE CURSE")
			connection.send("say", "/giveeffect " + randomPlayer + " curse 20");
			connection.send("say", "[CURSEBOT] " + randomPlayer + " has curse");
		}
	}

}


// send "init"
connection.send("init");



						//Here's where your bot code ends!
					}).catch(__EEJSIDE__ => {
						__EEJSIDE_______("Error Joining Room: " + __EEJSIDE__);
					}));
				}).catch(__EEJSIDE_ => {
					__EEJSIDE_______("Error Authenticating: " + __EEJSIDE_);
				}));
			}
		</script>
	</body>
</html>
